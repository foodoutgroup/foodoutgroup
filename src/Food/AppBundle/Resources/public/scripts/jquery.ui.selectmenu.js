/*
 * jQuery UI Selectmenu version 1.5.0pre
 *
 * Copyright (c) 2009-2010 filament group, http://filamentgroup.com
 * Copyright (c) 2010-2013 Felix Nagel, http://www.felixnagel.com
 * Licensed under the MIT (MIT-LICENSE.txt)
 *
 * https://github.com/fnagel/jquery-ui/wiki/Selectmenu
 */

(function(e){e.widget("ui.selectmenu",{options:{appendTo:"body",typeAhead:1e3,style:"dropdown",positionOptions:null,width:null,menuWidth:null,handleWidth:26,maxHeight:null,icons:null,format:null,escapeHtml:false,bgImage:function(){}},_create:function(){var t=this,n=this.options;var r=this.element.uniqueId().attr("id");this.ids=[r,r+"-button",r+"-menu"];this._safemouseup=true;this.isOpen=false;this.newelement=e("<a />",{"class":"ui-selectmenu ui-widget ui-state-default ui-corner-all",id:this.ids[1],role:"button",href:"#nogo",tabindex:this.element.attr("disabled")?1:0,"aria-haspopup":true,"aria-owns":this.ids[2]});this.newelementWrap=e("<span />").append(this.newelement).insertAfter(this.element);var i=this.element.attr("tabindex");if(i){this.newelement.attr("tabindex",i)}this.newelement.data("selectelement",this.element);this.selectmenuIcon=e('<span class="ui-selectmenu-icon ui-icon"></span>').prependTo(this.newelement);this.newelement.prepend('<span class="ui-selectmenu-status" />');this.element.bind({"click.selectmenu":function(e){t.newelement.focus();e.preventDefault()}});this.newelement.bind("mousedown.selectmenu",function(e){t._toggle(e,true);if(n.style=="popup"){t._safemouseup=false;setTimeout(function(){t._safemouseup=true},300)}e.preventDefault()}).bind("click.selectmenu",function(e){e.preventDefault()}).bind("keydown.selectmenu",function(n){var r=false;switch(n.keyCode){case e.ui.keyCode.ENTER:r=true;break;case e.ui.keyCode.SPACE:t._toggle(n);break;case e.ui.keyCode.UP:if(n.altKey){t.open(n)}else{t._moveSelection(-1)}break;case e.ui.keyCode.DOWN:if(n.altKey){t.open(n)}else{t._moveSelection(1)}break;case e.ui.keyCode.LEFT:t._moveSelection(-1);break;case e.ui.keyCode.RIGHT:t._moveSelection(1);break;case e.ui.keyCode.TAB:r=true;break;case e.ui.keyCode.PAGE_UP:case e.ui.keyCode.HOME:t.index(0);break;case e.ui.keyCode.PAGE_DOWN:case e.ui.keyCode.END:t.index(t._optionLis.length);break;default:r=true}return r}).bind("keypress.selectmenu",function(e){if(e.which>0){t._typeAhead(e.which,"mouseup")}return true}).bind("mouseover.selectmenu",function(){if(!n.disabled)e(this).addClass("ui-state-hover")}).bind("mouseout.selectmenu",function(){if(!n.disabled)e(this).removeClass("ui-state-hover")}).bind("focus.selectmenu",function(){if(!n.disabled)e(this).addClass("ui-state-focus")}).bind("blur.selectmenu",function(){if(!n.disabled)e(this).removeClass("ui-state-focus")});e(document).bind("mousedown.selectmenu-"+this.ids[0],function(n){if(t.isOpen&&!e(n.target).closest("#"+t.ids[1]).length){t.close(n)}});this.element.bind("click.selectmenu",function(){t._refreshValue()}).bind("focus.selectmenu",function(){if(t.newelement){t.newelement[0].focus()}});if(!n.width){n.width=this.element.outerWidth()}this.newelement.width(n.width);this.element.hide();this.list=e("<ul />",{"class":"ui-widget ui-widget-content","aria-hidden":true,role:"listbox","aria-labelledby":this.ids[1],id:this.ids[2]});this.listWrap=e("<div />",{"class":"ui-selectmenu-menu"}).append(this.list).appendTo(n.appendTo);this.list.bind("keydown.selectmenu",function(n){var r=false;switch(n.keyCode){case e.ui.keyCode.UP:if(n.altKey){t.close(n,true)}else{t._moveFocus(-1)}break;case e.ui.keyCode.DOWN:if(n.altKey){t.close(n,true)}else{t._moveFocus(1)}break;case e.ui.keyCode.LEFT:t._moveFocus(-1);break;case e.ui.keyCode.RIGHT:t._moveFocus(1);break;case e.ui.keyCode.HOME:t._moveFocus(":first");break;case e.ui.keyCode.PAGE_UP:t._scrollPage("up");break;case e.ui.keyCode.PAGE_DOWN:t._scrollPage("down");break;case e.ui.keyCode.END:t._moveFocus(":last");break;case e.ui.keyCode.ENTER:case e.ui.keyCode.SPACE:t.close(n,true);e(n.target).parents("li:eq(0)").trigger("mouseup");break;case e.ui.keyCode.TAB:r=true;t.close(n,true);e(n.target).parents("li:eq(0)").trigger("mouseup");break;case e.ui.keyCode.ESCAPE:t.close(n,true);break;default:r=true}return r}).bind("keypress.selectmenu",function(e){if(e.which>0){t._typeAhead(e.which,"focus")}return true}).bind("mousedown.selectmenu mouseup.selectmenu",function(){return false});e(window).bind("resize.selectmenu-"+this.ids[0],e.proxy(t.close,this))},_init:function(){var t=this,n=this.options;var r=[];this.element.find("option").each(function(){var i=e(this);r.push({value:i.attr("value"),text:t._formatText(i.text(),i),selected:i.attr("selected"),disabled:i.attr("disabled"),classes:i.attr("class"),typeahead:i.attr("typeahead"),parentOptGroup:i.parent("optgroup"),bgImage:n.bgImage.call(i)})});var i=t.options.style=="popup"?" ui-state-active":"";this.list.html("");if(r.length){for(var s=0;s<r.length;s++){var o={role:"presentation"};if(r[s].disabled){o["class"]="ui-state-disabled"}var u={html:r[s].text||"&nbsp;",href:"#nogo",tabindex:-1,role:"option","aria-selected":false};if(r[s].disabled){u["aria-disabled"]=true}if(r[s].typeahead){u["typeahead"]=r[s].typeahead}var a=e("<a/>",u).bind("focus.selectmenu",function(){e(this).parent().mouseover()}).bind("blur.selectmenu",function(){e(this).parent().mouseout()});var f=e("<li/>",o).append(a).data("index",s).addClass(r[s].classes).data("optionClasses",r[s].classes||"").bind("mouseup.selectmenu",function(n){if(t._safemouseup&&!t._disabled(n.currentTarget)&&!t._disabled(e(n.currentTarget).parents("ul > li.ui-selectmenu-group "))){t.index(e(this).data("index"));t.select(n);t.close(n,true)}return false}).bind("click.selectmenu",function(){return false}).bind("mouseover.selectmenu",function(n){if(!e(this).hasClass("ui-state-disabled")&&!e(this).parent("ul").parent("li").hasClass("ui-state-disabled")){n.optionValue=t.element[0].options[e(this).data("index")].value;t._trigger("hover",n,t._uiHash());t._selectedOptionLi().addClass(i);t._focusedOptionLi().removeClass("ui-selectmenu-item-focus ui-state-hover");e(this).removeClass("ui-state-active").addClass("ui-selectmenu-item-focus ui-state-hover")}}).bind("mouseout.selectmenu",function(n){if(e(this).is(t._selectedOptionLi())){e(this).addClass(i)}n.optionValue=t.element[0].options[e(this).data("index")].value;t._trigger("blur",n,t._uiHash());e(this).removeClass("ui-selectmenu-item-focus ui-state-hover")});if(r[s].parentOptGroup.length){var l="ui-selectmenu-group-"+this.element.find("optgroup").index(r[s].parentOptGroup);if(this.list.find("li."+l).length){this.list.find("li."+l+":last ul").append(f)}else{e('<li role="presentation" class="ui-selectmenu-group '+l+(r[s].parentOptGroup.attr("disabled")?" "+'ui-state-disabled" aria-disabled="true"':'"')+'><span class="ui-selectmenu-group-label">'+r[s].parentOptGroup.attr("label")+"</span><ul></ul></li>").appendTo(this.list).find("ul").append(f)}}else{f.appendTo(this.list)}if(n.icons){for(var c in n.icons){if(f.is(n.icons[c].find)){f.data("optionClasses",r[s].classes+" ui-selectmenu-hasIcon").addClass("ui-selectmenu-hasIcon");var h=n.icons[c].icon||"";f.find("a:eq(0)").prepend('<span class="ui-selectmenu-item-icon ui-icon '+h+'"></span>');if(r[s].bgImage){f.find("span").css("background-image",r[s].bgImage)}}}}}}else{e('<li role="presentation"><a href="#nogo" tabindex="-1" role="option"></a></li>').appendTo(this.list)}var p=n.style=="dropdown";this.newelement.toggleClass("ui-selectmenu-dropdown",p).toggleClass("ui-selectmenu-popup",!p);this.list.toggleClass("ui-selectmenu-menu-dropdown ui-corner-bottom",p).toggleClass("ui-selectmenu-menu-popup ui-corner-all",!p).find("li:first").toggleClass("ui-corner-top",!p).end().find("li:last").addClass("ui-corner-bottom");this.selectmenuIcon.toggleClass("ui-icon-triangle-1-s",p).toggleClass("ui-icon-triangle-2-n-s",!p);if(n.style=="dropdown"){this.list.width(n.menuWidth?n.menuWidth:n.width)}else{this.list.width(n.menuWidth?n.menuWidth:n.width-n.handleWidth)}this.list.css("height","auto");var d=this.listWrap.height();var v=e(window).height();var m=n.maxHeight?Math.min(n.maxHeight,v):v/3;if(d>m)this.list.height(m);this._optionLis=this.list.find("li:not(.ui-selectmenu-group)");if(this.element.attr("disabled")){this.disable()}else{this.enable()}this._refreshValue();this._selectedOptionLi().addClass("ui-selectmenu-item-focus");clearTimeout(this.refreshTimeout);this.refreshTimeout=window.setTimeout(function(){t._refreshPosition()},200)},destroy:function(){this.element.removeData(this.widgetName).removeClass("ui-selectmenu-disabled"+" "+"ui-state-disabled").removeAttr("aria-disabled").unbind(".selectmenu");e(window).unbind(".selectmenu-"+this.ids[0]);e(document).unbind(".selectmenu-"+this.ids[0]);this.newelementWrap.remove();this.listWrap.remove();this.element.unbind(".selectmenu").show();e.Widget.prototype.destroy.apply(this,arguments)},_typeAhead:function(e,t){var n=this,r=String.fromCharCode(e).toLowerCase(),i=null,s=null;if(n._typeAhead_timer){window.clearTimeout(n._typeAhead_timer);n._typeAhead_timer=undefined}n._typeAhead_chars=(n._typeAhead_chars===undefined?"":n._typeAhead_chars).concat(r);if(n._typeAhead_chars.length<2||n._typeAhead_chars.substr(-2,1)===r&&n._typeAhead_cycling){n._typeAhead_cycling=true;i=r}else{n._typeAhead_cycling=false;i=n._typeAhead_chars}var o=(t!=="focus"?this._selectedOptionLi().data("index"):this._focusedOptionLi().data("index"))||0;for(var u=0;u<this._optionLis.length;u++){var a=this._optionLis.eq(u).text().substr(0,i.length).toLowerCase();if(a===i){if(n._typeAhead_cycling){if(s===null)s=u;if(u>o){s=u;break}}else{s=u}}}if(s!==null){this._optionLis.eq(s).find("a").trigger(t)}n._typeAhead_timer=window.setTimeout(function(){n._typeAhead_timer=undefined;n._typeAhead_chars=undefined;n._typeAhead_cycling=undefined},n.options.typeAhead)},_uiHash:function(){var t=this.index();return{index:t,option:e("option",this.element).get(t),value:this.element[0].value}},open:function(e){if(this.newelement.attr("aria-disabled")!="true"){var t=this,n=this.options,r=this._selectedOptionLi(),i=r.find("a");t._closeOthers(e);t.newelement.addClass("ui-state-active");t.list.attr("aria-hidden",false);t.listWrap.addClass("ui-selectmenu-open");if(n.style=="dropdown"){t.newelement.removeClass("ui-corner-all").addClass("ui-corner-top")}else{this.list.css("left",-5e3).scrollTop(this.list.scrollTop()+r.position().top-this.list.outerHeight()/2+r.outerHeight()/2).css("left","auto")}t._refreshPosition();if(i.length){i[0].focus()}t.isOpen=true;t._trigger("open",e,t._uiHash())}},close:function(e,t){if(this.newelement.is(".ui-state-active")){this.newelement.removeClass("ui-state-active");this.listWrap.removeClass("ui-selectmenu-open");this.list.attr("aria-hidden",true);if(this.options.style=="dropdown"){this.newelement.removeClass("ui-corner-top").addClass("ui-corner-all")}if(t){this.newelement.focus()}this.isOpen=false;this._trigger("close",e,this._uiHash())}},change:function(e){this.element.trigger("change");this._trigger("change",e,this._uiHash())},select:function(e){if(this._disabled(e.currentTarget)){return false}this._trigger("select",e,this._uiHash())},widget:function(){return this.listWrap.add(this.newelementWrap)},_closeOthers:function(t){e(".ui-selectmenu.ui-state-active").not(this.newelement).each(function(){e(this).data("selectelement").selectmenu("close",t)});e(".ui-selectmenu.ui-state-hover").trigger("mouseout")},_toggle:function(e,t){if(this.isOpen){this.close(e,t)}else{this.open(e)}},_formatText:function(t,n){if(this.options.format){t=this.options.format(t,n)}else if(this.options.escapeHtml){t=e("<div />").text(t).html()}return t},_selectedIndex:function(){return this.element[0].selectedIndex},_selectedOptionLi:function(){return this._optionLis.eq(this._selectedIndex())},_focusedOptionLi:function(){return this.list.find(".ui-selectmenu-item-focus")},_moveSelection:function(e,t){if(!this.options.disabled){var n=parseInt(this._selectedOptionLi().data("index")||0,10);var r=n+e;if(r<0){r=0}if(r>this._optionLis.size()-1){r=this._optionLis.size()-1}if(r===t){return false}if(this._optionLis.eq(r).hasClass("ui-state-disabled")){e>0?++e:--e;this._moveSelection(e,r)}else{this._optionLis.eq(r).trigger("mouseover").trigger("mouseup")}}},_moveFocus:function(e,t){if(!isNaN(e)){var n=parseInt(this._focusedOptionLi().data("index")||0,10);var r=n+e}else{var r=parseInt(this._optionLis.filter(e).data("index"),10)}if(r<0){r=0}if(r>this._optionLis.size()-1){r=this._optionLis.size()-1}if(r===t){return false}var i="ui-selectmenu-item-"+Math.round(Math.random()*1e3);this._focusedOptionLi().find("a:eq(0)").attr("id","");if(this._optionLis.eq(r).hasClass("ui-state-disabled")){e>0?++e:--e;this._moveFocus(e,r)}else{this._optionLis.eq(r).find("a:eq(0)").attr("id",i).focus()}this.list.attr("aria-activedescendant",i)},_scrollPage:function(e){var t=Math.floor(this.list.outerHeight()/this._optionLis.first().outerHeight());t=e=="up"?-t:t;this._moveFocus(t)},_setOption:function(e,t){this.options[e]=t;if(e=="disabled"){if(t)this.close();this.element.add(this.newelement).add(this.list)[t?"addClass":"removeClass"]("ui-selectmenu-disabled "+"ui-state-disabled").attr("aria-disabled",t).attr("tabindex",t?1:0)}},disable:function(e,t){if(typeof e=="undefined"){this._setOption("disabled",true)}else{this._toggleEnabled(t||"option",e,false)}},enable:function(e,t){if(typeof e=="undefined"){this._setOption("disabled",false)}else{this._toggleEnabled(t||"option",e,true)}},_disabled:function(t){return e(t).hasClass("ui-state-disabled")},_toggleEnabled:function(e,t,n){var r=this.element.find(e).eq(t),i=e==="optgroup"?this.list.find("li.ui-selectmenu-group-"+t):this._optionLis.eq(t);if(i){i.toggleClass("ui-state-disabled",!n).attr("aria-disabled",!n);if(n){r.removeAttr("disabled")}else{r.attr("disabled","disabled")}}},index:function(t){if(arguments.length){if(!this._disabled(e(this._optionLis[t]))&&t!=this._selectedIndex()){this.element[0].selectedIndex=t;this._refreshValue();this.change()}else{return false}}else{return this._selectedIndex()}},value:function(e){if(arguments.length&&e!=this.element[0].value){this.element[0].value=e;this._refreshValue();this.change()}else{return this.element[0].value}},_refreshValue:function(){var e=this.options.style=="popup"?" ui-state-active":"";var t="ui-selectmenu-item-"+Math.round(Math.random()*1e3);this.list.find(".ui-selectmenu-item-selected").removeClass("ui-selectmenu-item-selected"+e).find("a").attr("aria-selected","false").attr("id","");this._selectedOptionLi().addClass("ui-selectmenu-item-selected"+e).find("a").attr("aria-selected","true").attr("id",t);var n=this.newelement.data("optionClasses")?this.newelement.data("optionClasses"):"";var r=this._selectedOptionLi().data("optionClasses")?this._selectedOptionLi().data("optionClasses"):"";this.newelement.removeClass(n).data("optionClasses",r).addClass(r).find(".ui-selectmenu-status").html(this._selectedOptionLi().find("a:eq(0)").html());this.list.attr("aria-activedescendant",t)},_refreshPosition:function(){var t=this.options,n={of:this.newelement,my:"left top",at:"left bottom",collision:"flip"};if(t.style=="popup"){var r=this._selectedOptionLi();n.my="left top"+(this.list.offset().top-r.offset().top-(this.newelement.outerHeight()+r.outerHeight())/2);n.collision="fit"}this.listWrap.removeAttr("style").zIndex(this.element.zIndex()+2).position(e.extend(n,t.positionOptions))}})})(jQuery)