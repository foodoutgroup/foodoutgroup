{% extends 'FoodAppBundle::layout.html.twig' %}


    {% block jscode %}
        $(document).ready(function(){
            $('#index_city').selectmenu();

            var addrXhr = null;
            var addrResponse = {};
            var waitIntervals = null;
            var currentTime = null;
            var closeBtnTxt = '{% trans %}general.close_btn{% endtrans %}';


            function getCrds() {
                if (addrXhr != null) {
                    addrXhr.abort();
                }
                addrXhr = $.ajax({
                    type: 'GET',
                    url: '{{ path('food_ajax', {'action': 'find-address'}) }}',
                    data:  {
                        city: $('#index_city').val(),
                        address: $('#index_address').val() + ' ' + $('#index_house').val()
                    },
                    success:  function(resp){
                        if (resp.data.success == 1) {
                            $('.search-food-form').trigger('submit');
                        } else {
                            var dialogOpts = {
                                modal: true,
                                resizable: false,
                                buttons: {
                                    'close': {
                                        'text': closeBtnTxt,
                                        'click': function() {
                                            $(this).dialog('close');
                                        }
                                    }
                                }
                            };
                            $("<div>"+resp.data.message+"</div>").dialog(dialogOpts).siblings('.ui-dialog-titlebar').remove();
                        }
                    }
                });
            }

            $('#index_submit').click(function(e){
                if ($('#index_city').val() !="" && $('#index_city').val() != null && $('#index_address').val()=="") {
                    var url = '{{ path('food_lang_homepage') }}' + $('#index_city option:selected').data('cityurl');
                    window.location.href = url;
                } else {
                    getCrds();
                }
                e.stopPropagation();
                e.preventDefault();
            });

            function waitForState() {
                if (waitIntervals < 20) {
                    if (addrXhr.readyState == 4) {
                        //$('.search-food-form').trigger('submit');
                    } else {
                        waitIntervals++;
                        setTimeout(function() { waitForState(); }, 1000);
                    }
                }
            }
            $('#index_city').change(function(){
                $(this).next('span').find('a').find('span:first').addClass('nodisabled');

            });
        });
        initStreetSearch();
        initStreetHouseSearch();
    {% endblock %}

{% block title %}{% trans %}general.base_page_title{% endtrans %} | {{ page_title }}{% endblock %}
{% block seo_description %}{% trans %}general.base_page_description{% endtrans %}{% endblock %}

{% block delfi_js %}
    {% if show_delfi_banner %}
       {{ misc_utils.param('delfiJs', true)|raw }}
    {% endif %}
{% endblock %}

{% block delfi_banner %}
    {% if show_delfi_banner %}
       {{ misc_utils.param('delfiBanner', true)|raw }}
    {% endif %}
{% endblock %}

{% block body %}
    {# image randomization according to country #}
    <div style="background-image: url(//{{ cloudfront_url }}{{ asset('bundles/foodapp/images/title_offer/offer-'~site_country|lower~'-'~random(['2', '3', '4', '5', '6', '9', '10', '14'])~'.jpg') }});" class="site-header special-offer-block">
        <div class="site-block">
            <h1 class="no-wrap">{% trans %}index.title_page_header{% endtrans %}</h1>
            <form class="search-food-form"  action="{{ path('food_places_' ~ locale ~ '_main') }}" method="get">
                <p class="title">{% trans %}index.search_form_qlue{% endtrans %}</p>
                <div class="clearfix">
                    {# TODO remove city hardcode, damn it... #}
                    <select id="index_city">
                        <option value="" data-cityurl="" disabled {% if formDefaults.city == '' %}selected{% endif %}>{% trans %}index.city{% endtrans %}</option>
                        {% for city in available_cities %}
                            <option value="{{ city }}" data-cityurl="{{ city|replace({'ė':'e','Š':'S','ž':'z','ī':'i'}) }}" {% if formDefaults.city == city or formDefaults.city == city|replace({'ė':'e','Š':'S','ž':'z','ī':'i'}) %}selected{% endif %}>{{ city }}</option>
                        {% endfor %}
                    </select>

                    {# <input type="text" id="index_city" placeholder="{% trans %}index.city{% endtrans %}"  autocomplete="off" > #}
                    <input type="text" id="index_address" placeholder="{% trans %}index.street{% endtrans %}" class="input-street" autocomplete="off" value="{{ formDefaults.address }}" />
                    <input type="text" id="index_house" placeholder="{% trans %}index.house{% endtrans %} - {% trans %}index.flat{% endtrans %}" class="input-house" autocomplete="off" value="{{ formDefaults.house }}{% if formDefaults.flat %} - {{ formDefaults.flat }}{% endif %}" />
                    <input type="submit" id="index_submit" value="{% trans %}index.findfood{% endtrans %}" />
                </div>
            </form>
        </div>
        <p class="img-description">{# pavadinimas produkto, vietove, kaina #}</p>
    </div>
    <div class="site-center">
        <div class="site-block">
            {{ render(controller('FoodPlacesBundle:Default:recommended')) }}
        </div>
        {% if show_game %}
            <div class="site-block banner">
                {% if site_country == 'LT' %}
                    {% if random(3) < 2 %}
                        <script src="https://code.createjs.com/createjs-2015.11.26.min.js"></script>
                        <script src="https://foodout.lt/fobirthday/900x300_FO-gimtadienis.js"></script>
                        <canvas id="fobirthday" width="900" height="300" style="display: block; background-color:rgba(255, 255, 255, 1.00); margin: 0 auto;" onclick="window.location.href='https://foodout.lt/gimtadienio-zaidimas/'"></canvas>
                        <script>
                            var canvas, stage, exportRoot;
                            function initFOBirthday() {
                                canvas = document.getElementById("fobirthday");
                                images = images||{};
                                ss = ss||{};
                                var loader = new createjs.LoadQueue(false);
                                loader.addEventListener("fileload", handleFileLoad);
                                loader.addEventListener("complete", handleComplete);
                                loader.loadManifest(lib.properties.manifest);
                            }
                            function handleFileLoad(evt) {
                                if (evt.item.type == "image") { images[evt.item.id] = evt.result; }
                            }
                            function handleComplete(evt) {
                                //This function is always called, irrespective of the content. You can use the variable "stage" after it is created in token create_stage.
                                var queue = evt.target;
                                var ssMetadata = lib.ssMetadata;
                                for(i=0; i<ssMetadata.length; i++) {
                                    ss[ssMetadata[i].name] = new createjs.SpriteSheet( {"images": [queue.getResult(ssMetadata[i].name)], "frames": ssMetadata[i].frames} )
                                }
                                exportRoot = new lib._900x300_FOgimtadienis();
                                stage = new createjs.Stage(canvas);
                                stage.addChild(exportRoot);
                                //Registers the "tick" event listener.
                                createjs.Ticker.setFPS(lib.properties.fps);
                                createjs.Ticker.addEventListener("tick", stage);
                                //Code to support hidpi screens and responsive scaling.
                                (function(isResp, respDim, isScale, scaleType) {
                                    var lastW, lastH, lastS=1;
                                    window.addEventListener('resize', resizeCanvas);
                                    resizeCanvas();
                                    function resizeCanvas() {
                                        var w = lib.properties.width, h = lib.properties.height;
                                        var iw = window.innerWidth, ih=window.innerHeight;
                                        var pRatio = window.devicePixelRatio || 1, xRatio=iw/w, yRatio=ih/h, sRatio=1;
                                        if(isResp) {
                                            if((respDim=='width'&&lastW==iw) || (respDim=='height'&&lastH==ih)) {
                                                sRatio = lastS;
                                            }
                                            else if(!isScale) {
                                                if(iw<w || ih<h)
                                                    sRatio = Math.min(xRatio, yRatio);
                                            }
                                            else if(scaleType==1) {
                                                sRatio = Math.min(xRatio, yRatio);
                                            }
                                            else if(scaleType==2) {
                                                sRatio = Math.max(xRatio, yRatio);
                                            }
                                        }
                                        canvas.width = w*pRatio*sRatio;
                                        canvas.height = h*pRatio*sRatio;
                                        canvas.style.width = w*sRatio+'px';
                                        canvas.style.height = h*sRatio+'px';
                                        stage.scaleX = pRatio*sRatio;
                                        stage.scaleY = pRatio*sRatio;
                                        lastW = iw; lastH = ih; lastS = sRatio;
                                    }
                                })(false,'both',false,1);
                            }
                            initFOBirthday();
                        </script>
                    {% else %}
                    <ins data-revive-zoneid="8" data-revive-id="12b88dd43b1c40010eb436263abc6451"></ins>
                    <script async src="//ads.foodout.lt/delivery/asyncjs.php"></script>
                    {% endif %}
                {% else %}
                    <ins data-revive-zoneid="16" data-revive-id="12b88dd43b1c40010eb436263abc6451"></ins>
                    <script async src="//ads.foodout.lt/delivery/asyncjs.php"></script>
                {% endif %}
            </div>
        {% endif %}

        {% if show_best_offers %}
            <div class="site-block">
                {{ render(controller('FoodPlacesBundle:Default:bestOffers')) }}
            </div>
        {% endif %}
    </div>
{% endblock %}
