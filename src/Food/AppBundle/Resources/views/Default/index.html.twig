{% extends 'FoodAppBundle::layout.html.twig' %}


    {% block jscode %}
        $(document).ready(function(){
            $('#index_city').selectmenu();

            var addrXhr = null;
            var addrResponse = {};
            var waitIntervals = null;
            var currentTime = null;
            var closeBtnTxt = '{% trans %}general.close_btn{% endtrans %}';


            function getCrds() {
                if (addrXhr != null) {
                    addrXhr.abort();
                }
                addrXhr = $.ajax({
                    type: 'GET',
                    url: '{{ path('food_ajax', {'action': 'find-address'}) }}',
                    data:  {
                        city: $('#index_city').val(),
                        address: $('#index_address').val() + ' ' + $('#index_house').val()
                    },
                    success:  function(resp){
                        if (resp.data.success == 1) {
                            $('.search-food-form').trigger('submit');
                        } else {
                            var dialogOpts = {
                                modal: true,
                                resizable: false,
                                buttons: {
                                    'close': {
                                        'text': closeBtnTxt,
                                        'click': function() {
                                            $(this).dialog('close');
                                        }
                                    }
                                }
                            };
                            $("<div>"+resp.data.message+"</div>").dialog(dialogOpts).siblings('.ui-dialog-titlebar').remove();
                        }
                    }
                });
            }

            $('#index_submit').click(function(e){
                if ($('#index_city').val() !="" && $('#index_city').val() != null && $('#index_address').val()=="") {
                    var url = '{{ path('food_places_lt_main') }}' + $('#index_city').val();
                    window.location.href = url;
                } else {
                    getCrds();
                }
                e.stopPropagation();
                e.preventDefault();
            });

            function waitForState() {
                if (waitIntervals < 20) {
                    if (addrXhr.readyState == 4) {
                        //$('.search-food-form').trigger('submit');
                    } else {
                        waitIntervals++;
                        setTimeout(function() { waitForState(); }, 1000);
                    }
                }
            }
            $('#index_city').change(function(){
                $(this).next('span').find('a').find('span:first').addClass('nodisabled');

            });
        });
        initStreetSearch();
        initStreetHouseSearch();
    {% endblock %}

{% block title %}{% trans %}general.base_page_title{% endtrans %} | {{ page_title }}{% endblock %}

{% block body %}

    <div style="background-image: url(http://{{ cloudfront_url }}{{ asset('bundles/foodapp/images/offer-1.jpg') }});" class="site-header special-offer-block">
        <div class="site-block">
            <h1 class="no-wrap">{% trans %}index.title_page_header{% endtrans %}</h1>
            <form class="search-food-form"  action="{{ path('food_places_' ~ locale ~ '_main') }}" method="get">
                <p class="title">{% trans %}index.search_form_qlue{% endtrans %}</p>
                <div class="clearfix">
                    {# TODO remove city hardcode, damn it... #}
                    <select id="index_city">
                        <option value="" disabled {% if formDefaults.city == '' %}selected{% endif %}>{% trans %}index.city{% endtrans %}</option>
                        {% for city in available_cities %}
                            <option value="{{ city }}" {% if formDefaults.city == city or formDefaults.city == city|replace({'ė':'e','y':'ī'}) %}selected{% endif %}>{{ city }}</option>
                        {% endfor %}
                    </select>

                    {# <input type="text" id="index_city" placeholder="{% trans %}index.city{% endtrans %}"  autocomplete="off" > #}
                    <input type="text" id="index_address" placeholder="{% trans %}index.street{% endtrans %}" class="input-street" autocomplete="off" value="{{ formDefaults.address }}" />
                    <input type="text" id="index_house" placeholder="{% trans %}index.house{% endtrans %}" class="input-house" autocomplete="off" value="{{ formDefaults.house }}" />
                    <input type="submit" id="index_submit" value="{% trans %}index.findfood{% endtrans %}" />
                </div>
            </form>
        </div>
        <p class="img-description">{# pavadinimas produkto, vietove, kaina #}</p>
    </div>
    <div class="site-center">
        {% if show_best_offers %}
            <div class="site-block">
                {{ render(controller('FoodPlacesBundle:Default:bestOffers')) }}
            </div>
        {% endif %}

        {% if show_game %}
            <div class="site-block banner">
                <!--/*
                  *
                  * Revive Adserver Javascript Tag
                  * - Generated with Revive Adserver v3.2.1
                  *
                  */-->

                <!--/*
                  * The backup image section of this tag has been generated for use on a
                  * non-SSL page. If this tag is to be placed on an SSL page, change the
                  *   'http://ads.foodout.lt/delivery/...'
                  * to
                  *   'https://ads.foodout.lt/delivery/...'
                  *
                  * This noscript section of this tag only shows image banners. There
                  * is no width or height in these banners, so if you want these tags to
                  * allocate space for the ad before it shows, you will need to add this
                  * information to the <img> tag.
                  *
                  * If you do not want to deal with the intricities of the noscript
                  * section, delete the tag (from <noscript>... to </noscript>). On
                  * average, the noscript tag is called from less than 1% of internet
                  * users.
                  */-->

                <script type='text/javascript'><!--//<![CDATA[
                    var m3_u = (location.protocol=='https:'?'https://ads.foodout.lt/delivery/ajs.php':'http://ads.foodout.lt/delivery/ajs.php');
                    var m3_r = Math.floor(Math.random()*99999999999);
                    if (!document.MAX_used) document.MAX_used = ',';
                    document.write ("<scr"+"ipt type='text/javascript' src='"+m3_u);
                    document.write ("?zoneid=8");
                    document.write ('&amp;cb=' + m3_r);
                    if (document.MAX_used != ',') document.write ("&amp;exclude=" + document.MAX_used);
                    document.write (document.charset ? '&amp;charset='+document.charset : (document.characterSet ? '&amp;charset='+document.characterSet : ''));
                    document.write ("&amp;loc=" + escape(window.location));
                    if (document.referrer) document.write ("&amp;referer=" + escape(document.referrer));
                    if (document.context) document.write ("&context=" + escape(document.context));
                    if (document.mmm_fo) document.write ("&amp;mmm_fo=1");
                    document.write ("'><\/scr"+"ipt>");
                    //]]>--></script><noscript><a href='//ads.foodout.lt/delivery/ck.php?n=a4ff64bf&amp;cb=INSERT_RANDOM_NUMBER_HERE' target='_blank'><img src='//ads.foodout.lt/delivery/avw.php?zoneid=8&amp;cb=INSERT_RANDOM_NUMBER_HERE&amp;n=a4ff64bf' border='0' alt='' /></a></noscript>
            </div>
        {% endif %}

        <div class="site-block">
            {{ render(controller('FoodPlacesBundle:Default:recommended')) }}
        </div>
    </div>
{% endblock %}
