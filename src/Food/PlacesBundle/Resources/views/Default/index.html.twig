{% extends 'FoodAppBundle::layout.html.twig' %}

{% block title %}{% trans %}general.places{% endtrans %}{% if selected_kitchens_names %}: {% for name in selected_kitchens_names %}{{ name }}{% if not loop.last %} - {% endif %}{% endfor %}{% endif %} | {{ page_title }}{% endblock %}

{% block adnet_retargeting %}
    <!-- Adform Tracking Code BEGIN -->
    <script type="text/javascript">
        var _adftrack = {
            pm: 314127,
            divider: encodeURIComponent('|'),
            pagename: encodeURIComponent('Foodout.lt|{% trans %}general.places{% endtrans %}')
        };
        (function () { var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = 'https://track.adform.net/serving/scripts/trackpoint/async/'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x); })();

    </script>
    <noscript>
        <p style="margin:0;padding:0;border:0;">
            <img src="https://track.adform.net/Serving/TrackPoint/?pm=314127&ADFPageName=Foodout.lt|{% trans %}general.places{% endtrans %}&ADFdivider=|" width="1" height="1" alt="" />
        </p>
    </noscript>
    <!-- Adform Tracking Code END -->
{% endblock %}

{% block jscode %}

    var addressFound = {% if location != null and not location.not_found and location.street_found %}true{% else %}false{% endif %};

    $(document).ready(function() {
        $(".content-lefter").on('ifChecked', '.filters-list input', function(event) {
            $(this).attr('checked', true);
            submitKitchens();
        });



        // Delivery type filter
        $(".site-block").on('click', '.restaurants-list-top-filters .delivery-type-filter a', function(event) {
            $(".site-block .restaurants-list-top-filters .delivery-type-filter a.selected").removeClass('selected');
            $(event.target).addClass('selected');
            showFillAddress();
            submitKitchens();
        });

        $(".content-lefter").on('ifUnchecked', '.filters-list input', function(event) {
            $(this).attr('checked', false);
            submitKitchens();
        });

        $(document).on('click', '.clear-filter-link', function() {
            $.each($('.content-lefter input'), function(k, v) {
                $(v).attr('checked', false);
            });
            submitKitchens();
        });

        $(document).on('click', '.filters-list a', function() {
            targetInput = $(this).parent().find('input');
            if (targetInput.is(':checked')) {
                targetInput.attr('checked', false);
            } else {
                targetInput.attr('checked', true);
            }
            submitKitchens();
        });
        showFillAddress();
        function showFillAddress(){
            $('.alert-no-address').addClass('hidden');
            $('.restaurants-list-controls').removeClass('nab-visible').addClass('nab-hidden');
            if($('.delivery-type-filter a[class="selected"]').attr("data-type") == "delivery" && !addressFound){
                $('.alert-no-address').show().removeClass('hidden');
                $('.restaurants-list-controls').removeClass('nab-hidden').addClass('nab-visible');
            }

        }

        function submitKitchens() {

            var $filters = $(".filters-list input:checked");

            var params = {kitchens: '', filters: ''};
            var tmpName = "";
            var selectedKitchens = '';
            var selectedKitchensSlugs = '';
            var selectedKitchensNames = '';
            for(i = 0; i < $filters.length; i++) {
                tmpName = $($filters[i]).attr('name').replace("[]","");
                if (params[tmpName]!="") {
                    params[tmpName]+=",";
                }
                params[tmpName] += $($filters[i]).val();
                selectedKitchens += ','+$($filters[i]).val();
                selectedKitchensSlugs += ','+$($filters[i]).data('slug');
                selectedKitchensNames += ','+$($filters[i]).data('name');
            }
            params['delivery_type'] = $(".site-block .restaurants-list-top-filters .delivery-type-filter a.selected").attr('data-type');
            params['recommended'] = '{{ recommended }}';

            var kitchenParams = { 'recommended': '{{ recommended }}', 'delivery_type': params['delivery_type'], 'selected_kitchens': selectedKitchens, 'selected_kitchens_slugs': selectedKitchensSlugs};

            $.get('{{ path('food_kitchens_filter') }}', kitchenParams, function(resp) {
                var $container = $('.content-lefter');
                $container.find('.filter-title').remove();
                $container.find('.filters-list').remove();
                $container.prepend(resp);
                $container.iCheck();
            });

            var _url_slug_for_all = '{% trans %}kitchen.filter.slug{% endtrans %}';
            var _kitchens_count = 0;
            var _kitchens_array = selectedKitchens.split(',');
            $.each(_kitchens_array, function(i){
                if (_kitchens_array[i] !== '') {
                    _kitchens_count += 1;
                }
            });

            var _page_url = '';
            var _kitchensSlug_array = selectedKitchensSlugs.split(',');
            $.each(_kitchensSlug_array, function(i){
                if (_kitchensSlug_array[i] !== '') {
                    _page_url += _kitchensSlug_array[i] + '/';
                }
            });

            var _page_title = '%s | {{ page_title }}';
            var _title_row = '';
            var _kitchensName_array = selectedKitchensNames.split(',');
            $.each(_kitchensName_array, function(i){
                if (_kitchensName_array[i] !== '') {
                    _title_row += _kitchensName_array[i] + ' - ';
                }
            });

            var remove_last_slash = function(url) {
                if (url.charAt(url.length - 1) == "/") {
                    url = url.substr(0, url.length - 1);
                }
                return url;
            };

            var currentUrl = remove_last_slash('{{ city_url }}');
            var new_url = currentUrl + '/' + _page_url;

            document.title = _page_title.replace(/%s/g, '{% trans %}general.places{% endtrans %}' + (_title_row !== '' ? ': ' : '') + _title_row.substr(0, _title_row.length - 3));
            if (_kitchens_count > 1) {
                window.history.pushState("string", document.title, currentUrl + '/' + _url_slug_for_all + '/' + _page_url);
            } else {
                window.history.pushState("string", document.title, new_url.replace(_url_slug_for_all + '/', ''));
            }

            $('.restaurants-list').mask();
            $.post('{{ path('food_places_filter') }}', params, function(resp) {
                var $container = $('.content-righter');
                $('.restaurants-list').unmask();
                $container.find('.restaurants-list').remove();
                $container.unmask();
                $container.append(resp);

                $('.restoran-rating').raty({
                    readOnly: true,
                    score: function() {
                        return $(this).attr('data-stars');
                    },
                    path: '/bundles/foodapp/images/'
                });
            });
        }
    });
{% endblock %}
{% block body %}
    {# Facebook ViewContent Begin #}
    <script>fbq('track', 'ViewContent');</script>
    {# Facebook ViewContent End #}
    {% javascripts '@FoodAppBundle/Resources/public/scripts/fancy/jquery.fancybox.pack.js'
                   '@FoodAppBundle/Resources/public/scripts/fancy/helpers/jquery.fancybox-media.js' %}
        <script src="{{ asset_url }}"></script>
    {% endjavascripts %}

    {% stylesheets '@FoodAppBundle/Resources/public/scripts/fancy/jquery.fancybox.css' %}
        <link rel="stylesheet" href="{{ asset_url }}" type="text/css"  />
    {% endstylesheets %}

    <div class="change-location-box"></div>
    <div class="site-center">

    <div class="site-block">
    <div class="page-path clearfix">{% block breadcrumb %}{% endblock %}</div>
    <div class="page-title">
        {% block page_title_h1 %}
            <h1>{% trans %}places.header_main_part{% endtrans %}{%  if location is defined and location.city is defined %} {{ city_translations[location.city]|trans }}{% endif %}</h1>
        {% endblock %}
        <h2 class="clearfix">
            <span class="place-counter"></span>
        </h2>
    </div>

    <script type="text/javascript">
            $(document).on('click','.restaurants-list a',function(e){
                if($('.alert-no-address:visible').length && $('.delivery-type-filter a[class="selected"]').attr("data-type") == "delivery") {
                    e.preventDefault();
                    alert('{% trans %}please.fill.address.first{% endtrans %}')
                } else {

                }
            });

            $(document).ready(function() {
                $('.submit-address-change').click(function () {
                    var params = { city: $('#address_city').val(), address: $('#address').val(), currentUrl: window.location.href };
                    $.get('{{ url('food_ajax', {'action': 'find-address'}) }}', params, function (response) {
                        if(response.data.success == 1) {
                            window.location = window.location.href.split("#")[0];
                        } else {
                            alert(response.data.message);
                        }
                    });
                });
            });

    </script>

        {% set showNoAddress  = false %}
        <div class="clearfix">
            <div class="content-lefter">
                {{ render(controller('FoodDishesBundle:Kitchen:kitchenlist', {'recommended':recommended, 'slug_filter': slug_filter, 'zaval': zaval})) }}
                {{ render(controller('FoodDishesBundle:Place:filtersList')) }}
                <div class="banners">
                    {% if site_country == 'LT' %}
                        <div>
                            {#<ins data-revive-zoneid="13" data-revive-id="12b88dd43b1c40010eb436263abc6451"></ins>#}

                            {#<script type='text/javascript'>
                                OA_show('zone-1');
                            </script>#}
                            <iframe id='a5c12068' name='a5c12068' src='//ads.foodout.lt/delivery/afr.php?zoneid=13&amp;cb=213443425' frameborder='0' scrolling='no' width='180' height='250'><a href='//ads.foodout.lt/delivery/ck.php?n=a1fba806&amp;cb=INSERT_RANDOM_NUMBER_HERE' target='_blank'><img src='//ads.foodout.lt/delivery/avw.php?zoneid=13&amp;cb=INSERT_RANDOM_NUMBER_HERE&amp;n=a1fba806' border='0' alt='' /></a></iframe>
                        </div>

                        <div>
                            {#<script type='text/javascript'>
                                OA_show('zone-22');
                            </script>#}
                            <iframe id='ac4f9d5b' name='ac4f9d5b' src='//ads.foodout.lt/delivery/afr.php?zoneid=14&amp;cb=5646456846549' frameborder='0' scrolling='no' width='180' height='250'><a href='//ads.foodout.lt/delivery/ck.php?n=a10498ed&amp;cb=INSERT_RANDOM_NUMBER_HERE' target='_blank'><img src='//ads.foodout.lt/delivery/avw.php?zoneid=14&amp;cb=INSERT_RANDOM_NUMBER_HERE&amp;n=a10498ed' border='0' alt='' /></a></iframe>
                        </div>
                        <div>
                            {#<script type='text/javascript'>
                                OA_show('zona-3');
                            </script>#}
                            <iframe id='a9034681' name='a9034681' src='//ads.foodout.lt/delivery/afr.php?zoneid=15&amp;cb=852422323426' frameborder='0' scrolling='no' width='180' height='250'><a href='//ads.foodout.lt/delivery/ck.php?n=a5f27b25&amp;cb=INSERT_RANDOM_NUMBER_HERE' target='_blank'><img src='//ads.foodout.lt/delivery/avw.php?zoneid=15&amp;cb=INSERT_RANDOM_NUMBER_HERE&amp;n=a5f27b25' border='0' alt='' /></a></iframe>
                        </div>
                    {% else %}
                        {# Revive Ads init for foodout.lt #}
                        <div>
                            <iframe id='a5fe853c' name='a5fe853c' src='//ads.foodout.lt/delivery/afr.php?zoneid=18&amp;cb=5645641545' frameborder='0' scrolling='no' width='180' height='250'><a href='//ads.foodout.lt/delivery/ck.php?n=afb33539&amp;cb=INSERT_RANDOM_NUMBER_HERE' target='_blank'><img src='//ads.foodout.lt/delivery/avw.php?zoneid=18&amp;cb=INSERT_RANDOM_NUMBER_HERE&amp;n=afb33539' border='0' alt='' /></a></iframe>
                        </div>

                        <div>
                            <iframe id='a8768084' name='a8768084' src='//ads.foodout.lt/delivery/afr.php?zoneid=17&amp;cb=215453646' frameborder='0' scrolling='no' width='180' height='250'><a href='//ads.foodout.lt/delivery/ck.php?n=aa1b0015&amp;cb=INSERT_RANDOM_NUMBER_HERE' target='_blank'><img src='//ads.foodout.lt/delivery/avw.php?zoneid=17&amp;cb=INSERT_RANDOM_NUMBER_HERE&amp;n=aa1b0015' border='0' alt='' /></a></iframe>
                        </div>

                        <div>
                            <iframe id='a4bc4d32' name='a4bc4d32' src='//ads.foodout.lt/delivery/afr.php?zoneid=19&amp;cb=8754512333' frameborder='0' scrolling='no' width='180' height='250'><a href='//ads.foodout.lt/delivery/ck.php?n=a6d86579&amp;cb=INSERT_RANDOM_NUMBER_HERE' target='_blank'><img src='//ads.foodout.lt/delivery/avw.php?zoneid=19&amp;cb=INSERT_RANDOM_NUMBER_HERE&amp;n=a6d86579' border='0' alt='' /></a></iframe>
                        </div>
                        <script async src="//ads.foodout.lt/delivery/asyncjs.php"></script>
                    {% endif %}
                </div>
            </div>
            <div class="content-righter">

                <div class="alert-no-address {% if not showNoAddress %}hidden{% endif %}">
                    {% trans %}please.fill.address.message.top{% endtrans %}<br/>
                    <div class="input-section">
                        <select id="address_city" style="width: 120px;" class="custom-select">
                            {% for city in available_cities %}
                                <option value="{{ city|trim }}" {% if location and location.city is defined and (location.city == city or location.city == city|replace({'ė':'e','ī':'i'})) %}selected{% endif %}>{{places_service.getCityName(city)}}</option>
                            {% endfor %}
                        </select>
                        <input type="text"
                               id="address"
                               list="user_address"
                               value="{% if location and location.address_orig is defined %}{{ location.address_orig }}{% endif %}"
                               placeholder="{{ 'index.street'|trans }}" />
                        <button class="submit-address-change">{% trans %}save.button{% endtrans %}</button>
                    </div>
                    {% trans %}please.fill.address.message.bottom{% endtrans %}<br/>
                </div>

                <div class="restaurants-list-controls clearfix {% if showNoAddress %}nab-visible{% else %}nab-hidden{% endif %}">
                    <div class="restaurants-list-top-filters {% if zaval %}hidden{% endif %}">
                        <div class="delivery-type-filter">
                            <div class="label">{% trans %}places.filter_by_delivery{% endtrans %}:</div>
                            <a href="#" data-type="delivery" {% if delivery_type_filter == 'deliver' %}class="selected"{% endif %}>{% trans %}places.filter_delivery{% endtrans %}</a>
                            <a href="#" data-type="pickup" {% if delivery_type_filter == 'pickup' %}class="selected"{% endif %}>{% trans %}places.filter_pickup{% endtrans %}</a>
                        </div>
                    </div>
                </div>

                {% if zaval %}
                    {{ render(controller('FoodPlacesBundle:Default:list', {'recommended': recommended, 'slug_filter': slug_filter, 'zaval': true})) }}
                {% else %}
                    {{ render(controller('FoodPlacesBundle:Default:list', {'recommended': recommended, 'slug_filter': slug_filter})) }}
                {% endif %}
            </div>
        </div>

    </div>
    </div>
{% endblock %}
